# Nombre visible del workflow en la pestaña "Actions" de GitHub
name: Terraform CI

# Define cuándo se ejecuta el workflow
on:
  push:
    branches:
      - main         # Se ejecuta al hacer push en la rama main
  pull_request:      # También se ejecuta en pull requests

# Definimos tres jobs separados: format → validate → plan
jobs:

  # 🚦 Primer Job: Revisar el formato del código
  format:
    name: ✅ Terraform Format
    runs-on: ubuntu-latest    # Usa un runner de GitHub con Ubuntu

    steps:
      - name: Checkout code   # Clona el repositorio
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Format Check
        run: terraform fmt -check    # Verifica el formato del código Terraform

  # 🔍 Segundo Job: Validar la sintaxis (solo si pasó el formato)
  validate:
    name: 🔍 Terraform Validate
    runs-on: ubuntu-latest
    needs: format    # Este job se ejecuta solo si "format" fue exitoso

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        run: terraform init    # Inicializa el proyecto Terraform

      - name: Terraform Validate
        run: terraform validate    # Valida sintaxis, tipos y dependencias

  # 📦 Tercer Job: Planificar cambios en la infraestructura (solo si validó bien)
  plan:
    name: 📦 Terraform Plan
    runs-on: ubuntu-latest
    needs: validate    # Solo se ejecuta si "validate" fue exitoso

    # Se pasan las credenciales AWS desde los secrets de GitHub
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -var-file="terraform.tfvars"   # Usa el archivo de variables


# Nombre visible del workflow en la pestaÃ±a "Actions" de GitHub
name: Terraform CI

# Define cuÃ¡ndo se ejecuta el workflow
on:
  push:
    branches:
      - main         # Se ejecuta al hacer push en la rama main
  pull_request:      # TambiÃ©n se ejecuta en pull requests

# Definimos tres jobs separados: format â†’ validate â†’ plan
jobs:

  # ğŸš¦ Primer Job: Revisar el formato del cÃ³digo
  format:
    name: âœ… Terraform Format
    runs-on: ubuntu-latest    # Usa un runner de GitHub con Ubuntu

    steps:
      - name: Checkout code   # Clona el repositorio
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Format Check
        run: terraform fmt -check    # Verifica el formato del cÃ³digo Terraform

  # ğŸ” Segundo Job: Validar la sintaxis (solo si pasÃ³ el formato)
  validate:
    name: ğŸ” Terraform Validate
    runs-on: ubuntu-latest
    needs: format    # Este job se ejecuta solo si "format" fue exitoso

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        run: terraform init    # Inicializa el proyecto Terraform

      - name: Terraform Validate
        run: terraform validate    # Valida sintaxis, tipos y dependencias

  # ğŸ“¦ Tercer Job: Planificar cambios en la infraestructura (solo si validÃ³ bien)
  plan:
    name: ğŸ“¦ Terraform Plan
    runs-on: ubuntu-latest
    needs: validate    # Solo se ejecuta si "validate" fue exitoso

    # Se pasan las credenciales AWS desde los secrets de GitHub
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -var-file="terraform.tfvars"   # Usa el archivo de variables

